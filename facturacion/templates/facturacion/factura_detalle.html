{% extends 'accounts/base_dashboard.html' %}
{% load static %}
{% block title %}Facturas{% endblock %}
{% block header %}Facturas{% endblock %}
{% block content %}
<div class="container">
     <!-- SECCION DE TITULO ENCABEZANDO -->
     <div class="row">
          <div class="col">
               <h1 class="text-center">Factura {{ id }} </h1>
               <hr />
          </div>
     </div>
     <!-- BOTONES DE ACCIÓN -->
     <div class="dropdown text-end dropleft m-3">
          <!-- Botón para activar el dropdown -->
          <button class="btn btn-success dropdown-toggle mt-3" type="button" id="dropdownMenuButton"
              data-bs-toggle="dropdown" aria-expanded="false">
              Acciones para factura
          </button>
          <!-- Elementos del dropdown -->
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          
               {% if factura.estado == 'active' %}
               <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#CancelarCFDI">Cancelar factura</button>
               <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#ComprobanteCFDI">Generar comprobante de pago</button>
               <li>
                    <a class="dropdown-item" href="{% url 'generar_factura_pdf' factura.cfdi_id %}" target="_blank">
                         {% if factura.pdf_file %}
                              Descargar PDF
                         {% else %}
                              Generar PDF
                         {% endif %}
                    </a>
               </li>
               <li>
                    <a class="dropdown-item" href="{% url 'generar_factura_xml' factura.cfdi_id %}">
                         {% if factura.xml_file %}
                              Descargar XML
                         {% else %}
                              Generar XML
                         {% endif %}
                    </a>
               </li>
               {% else %}
               <li>
                    <a class="dropdown-item" href="{% url 'generar_factura_pdf' factura.cfdi_id %}" target="_blank">
                         {% if factura.pdf_file %}
                              Descargar PDF
                         {% else %}
                              Generar PDF
                         {% endif %}
                    </a>
               </li>
               <li>
                    <a class="dropdown-item" href="{% url 'generar_factura_xml' factura.cfdi_id %}">
                         {% if factura.xml_file %}
                              Descargar XML
                         {% else %}
                              Generar XML
                         {% endif %}
                    </a>
               </li>
               {% endif %}
          </ul>
      </div>
     <table class="table table-bordered">
          <thead>
               <tr>
                    <th colspan="2" class="text-center">FACTURA</th>
               </tr>
          </thead>
          <tbody>
               <tr>
                    <th scope="row">ID</th>
                    <td>factura {{ id }}</td>
               </tr>
               <tr>
                    <th scope="row">CFDI ID</th>
                    <td> {{ factura.cfdi_id }}</td>
               </tr>
               <tr>
                    <th scope="row">Orden de Trabajo</th>
                    <td> {{ factura.orden }}</td>
               </tr>
               <tr>
                    <th scope="row">Receptor / Cliente</th>
                    <td> {{ factura.emisor }}</td>
               </tr>
               <tr>
                    <th scope="row">Tipo Moneda</th>
                    <td> {{ factura.tipo_moneda }}</td>
               </tr>
               <tr>
                    <th scope="row">Uso CFDI</th>
                    <td> {{ factura.uso_cfdi }}</td>
               </tr>
               <tr>
                    <th scope="row">Forma de Pago</th>
                    <td> {{ factura.forma_pago }}</td>
               </tr>
               <tr>
                    <th scope="row">Metodo de Pago</th>
                    <td> {{ factura.metodo_pago }}</td>
               </tr>
               <tr>
                    <th scope="row">ExchangeRate</th>
                    <td> {{ factura.ExchangeRate }}</td>
               </tr>
               <tr>
                    <th scope="row">Descuento</th>
                    <td> {{ factura.Discount }}</td>
               </tr>
               <tr>
                    <th scope="row">Subtotal</th>
                    <td> {{ factura.subtotal }}</td>
               </tr>
               <tr>
                    <th scope="row">Tasa IVA</node>
                    <td> {{ factura.tasa_iva }}</node>
               </tr>
               <tr>
                    <th scope="row">IVA</node>
                    <td> {{ factura.iva }}</node>
               </tr>
               <tr>
                    <th scope="row">Total</node>
                    <td> {{ factura.total }}</node>
               </tr>
               <tr>
                    <th scope="row">Fecha</node>
                    <td> {{ factura.fecha_creacion }}</node>
               </tr>
               <tr>
                    <th scope="row">Estado</node>
                    <td> {{ factura.estado }}</node>
               </tr>
               <tr>
                    <th scope="row">ExpeditionPlace</node>
                    <td> {{ factura.ExpeditionPlace }}</node>
               </tr>

          </tbody>
     </table>
</div>

<!-- Modal para cancelar cfdi -->
<div class="modal fade" id="CancelarCFDI" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
     <div class="modal-dialog">
          <div class="modal-content">
               <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Cancelando Factura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                    <form action="{% url 'cancelar_factura' %}" method="post" id="cancelarCFDIForm">
                         {% csrf_token %}
                         <div class="mb-3">
                              {{ form_cancel.factura_id }}
                              {{ form_cancel.motive.label }}
                              {{ form_cancel.motive }} <!-- Asegúrate de que esto tenga un ID -->
                              <div id="uuidFieldContainer" style="display: none;" class="mt-2">
                                   <!-- Imprimir el label y el campo uuid_replacement manualmente -->
                                   {{ form_cancel.uuid_replacement.label }}
                                   {{ form_cancel.uuid_replacement }} <!-- Renderizar el campo de UUID -->
                              </div>
                         </div>
                    </form>
               </div>
               <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" form="cancelarCFDIForm">Guardar Cambios</button>
               </div>
          </div>
     </div>
</div>

<!-- Modal para comprobante de pago -->
<div class="modal fade" id="ComprobanteCFDI" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
     <div class="modal-dialog">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="modalLabel">Generar Comprobante de Pago</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
             <div class="modal-body">
                 <form action="{% url 'generar_comprobante_pago' factura.cfdi_id %}" method="post" id="comprobanteForm">
                     {% csrf_token %}
                     <div class="mb-3">
                         <label for="payment_date" class="form-label">Fecha de Pago</label>
                         <input type="datetime-local" class="form-control" id="payment_date" name="payment_date" required>
                     </div>
                     <div class="mb-3">
                         <label for="payment_form" class="form-label">Forma de Pago</label>
                         <select class="form-control" id="payment_form" name="payment_form" required>
                             <option value="01">Efectivo</option>
                             <option value="02">Cheque nominativo</option>
                             <option value="03">Transferencia electrónica de fondos</option>
                             <!-- Agrega más opciones según sea necesario -->
                         </select>
                     </div>
                     <div class="mb-3">
                         <label for="amount" class="form-label">Monto</label>
                         <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                     </div>
                     <div class="mb-3">
                         <label for="operation_number" class="form-label">Número de Operación</label>
                         <input type="text" class="form-control" id="operation_number" name="operation_number" required>
                     </div>
                     <!-- Campos adicionales según sea necesario -->
                 </form>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                 <button type="submit" class="btn btn-primary" form="comprobanteForm">Generar Comprobante</button>
             </div>
         </div>
     </div>
 </div>

<script>
     document.addEventListener('DOMContentLoaded', function () {
         // Inicialmente establecer la fecha y hora actuales en el campo de fecha de pago
         const paymentDateInput = document.getElementById('payment_date');
         const now = new Date();
         const year = now.getFullYear();
         const month = String(now.getMonth() + 1).padStart(2, '0');
         const day = String(now.getDate()).padStart(2, '0');
         const hours = String(now.getHours()).padStart(2, '0');
         const minutes = String(now.getMinutes()).padStart(2, '0');
         const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
         paymentDateInput.value = formattedDate;

         const selectOpciones = document.getElementById('select_opciones'); // Asegúrate de que este ID coincida
         const uuidFieldContainer = document.getElementById('uuidFieldContainer');
         const uuidReplacementField = document.getElementById('uuid_replacement');
 
         function toggleUUIDField() {
             if (selectOpciones.value === '01') {
                 uuidFieldContainer.style.display = 'block'; // Mostrar el campo
             } else {
                 uuidFieldContainer.style.display = 'none'; // Ocultar el campo
                 uuidReplacementField.value = ''; // Limpiar el campo si se oculta
             }
         }
 
         // Inicialmente ocultamos el campo
         toggleUUIDField();
 
         // Escuchar cambios en el select
         selectOpciones.addEventListener('change', toggleUUIDField);
     });
 </script>
 
{% endblock %}
